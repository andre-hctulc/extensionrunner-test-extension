var t,e,r,n=function(t,e,r,n,i){if("m"===n)throw TypeError("Private method is not writable");if("a"===n&&!i)throw TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!i:!e.has(t))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?i.call(t,r):i?i.value=r:e.set(t,r),r},i=function(t,e,r,n){if("a"===r&&!n)throw TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(t):n?n.value:e.get(t)};class a{constructor(e,r){this.type=e,this.payload=r,t.set(this,!1)}preventDefault(){n(this,t,!0,"f")}get defaultPrevented(){return i(this,t,"f")}}t=new WeakMap;class s{constructor(){e.set(this,new Map),r.set(this,new Set)}addEventListener(t,n){return t?(i(this,e,"f").has(t)||i(this,e,"f").set(t,new Set),i(this,e,"f").get(t)?.add(n)):i(this,r,"f").add(n),n}removeEventListener(t,n){null===t?i(this,r,"f").delete(n):i(this,e,"f").get(t)?.delete(n)}emitEvent(t,n){let s=new a(t,n);return i(this,e,"f").get(t)?.forEach(t=>t(s)),i(this,r,"f").forEach(t=>t(s)),s}clearListeners(){i(this,r,"f").clear(),i(this,e,"f").clear()}}function o(t,e){return t.data&&"object"==typeof t.data&&t.data.__type===e?t.data:null}e=new WeakMap,r=new WeakMap;const l="undefined"!=typeof window&&window===window.self;async function h(t,e,r,n="*",i,a=5e3){return new Promise((s,l)=>{let h=new MessageChannel,d=h.port1,u=h.port2,c=!1;setTimeout(()=>{c||l(Error("Operation timeout"))},a||5e3),d.onmessage=async t=>{let r=o(t,e+":result");r&&(c=!0,s(r.payload))},u.onmessageerror=t=>{l(Error("Channel Error (in)"))},d.onmessageerror=t=>{l(Error("Channel Error (out)"))},t.postMessage({...r,__type:e,__port:u},{targetOrigin:n,transfer:[u,...i||[]]})})}const d="https://cdn.jsdelivr.net";async function u(t,e,r,n){n.startsWith("/")?n=n.slice(1):n.startsWith("./")&&(n=n.slice(2));let i=await fetch(function(t,e,r,n){var i;let a;if("github"===t){let[t,n]=e.split("/");a=`${d}/gh/${t}/${n}@${r}/`}else if("npm"===t)a=`${d}/npm/${e}@${r}/`;else throw Error("Invalid type ('npm' or 'github' expected)");return n?((i=n).startsWith("./")?i=i.slice(2):i.startsWith("/")&&(i=i.slice(1)),a+(n=i)):a}(t,e,r,n),{});if(!i.ok)throw Error(`Failed to load file: ${i.statusText}`).response=i,Error(`Failed to load file: ${i.statusText}`);return i}const c=t=>{var e;if(p())return removeEventListener("message",c);let r=o(t,"meta");r&&(e=r.meta,globalThis.$ER||(globalThis.$ER={}),globalThis.$ER.meta=e,m(r.meta.initialState),f("ready",{__token:r.meta.authToken},"*"),removeEventListener("message",c))};function p(){return globalThis.$ER?.meta}function m(t){globalThis.$ER||(globalThis.$ER={}),globalThis.$ER.state=t||{}}function f(t,e,r,n){l?window.parent.postMessage({...e,__type:t},r,n||[]):self.postMessage({...e,__type:t},r,n||[])}addEventListener("message",c);let g=0;new class extends s{constructor(t){super(),this.init=t,this.id="adapter_id:"+function(){let t="abcdefghijklmnopqrstuvwxyz0123456789",e="";for(let r=0;r<25;r++){let r=Math.floor(Math.random()*t.length);e+=t[r]}return e}(),this._started=!1,this.listen()}listen(){addEventListener("message",async t=>{if(""!==t.origin&&t.origin!==this.init.provider){this.init.errorOnUnauthorized&&this.err("Unauthorized - Event origin and provider origin mismatch",void 0);return}if("string"==typeof t?.data?.__type)switch(t.data.__type){case"state_push":let e=t.data.state;if(!e||"object"!=typeof e)return this.err("Invalid state received",t);m(e),this.emitEvent("state_update",t.data.state);break;case"operation":let{args:r,operation:n,__port:i}=t.data;if(!i)return this.err("Operation Channel Error","Port not found");let a=await this.init.out?.[n];if("function"!=typeof a&&(a=null),i.onmessageerror=t=>{this.err("Operation Channel Error",t)},a)try{let t=await a.apply(this,r);i.postMessage({__type:"operation:result",payload:t}),this.emitEvent(`op:${n}`,{args:r,result:t,error:null})}catch(e){let t=this.err("Operation Execution Error",e);this.emitEvent(`op:${n}`,{args:r,result:void 0,error:t});return}else this.emitEvent(`op:${n}`,{args:r,result:void 0,error:null})}})}async start(t){return this._started?this:(this._started=!0,p())?(t&&t.apply(this,[this]),this):new Promise((e,r)=>{let n=!1;setTimeout(()=>{if(!n)return n=!0,r(Error("Provider start timeout"))},this.init.startTimeout||5e3),addEventListener("message",r=>{o(r,"meta")&&!n&&(n=!0,t&&t.apply(this,[this]),e(this))})})}get meta(){let t=p();if(!t)throw Error("Meta not defined. "+(this._started?"(unexpected)":"The adapter has not been started"));return t}get state(){return globalThis.$ER?.state||{}}err(t,e){let r=e instanceof Event?(e.message||e.data||"").toString():e instanceof Error?e.message:"",n=Error(`${t}${r?": "+r:""}`);return console.error(t,n),this.emitEvent("error",n),n}async execute(t,...e){return await h(l?parent:self,"operation",{args:e,operation:t,__token:this.meta.authToken},this.init.provider,[],this.init.operationTimeout)}async pushState(t,e){f("state_populate",{state:t,options:{merge:!e?.merge,populate:e?.populate!==!1},__token:this.meta.authToken},this.init.provider)}async loadFile(t){return await u(this.meta.type,this.meta.name,this.meta.version,t)}}({provider:"http://localhost:1234",errorOnUnauthorized:!0,out:{print:function(...t){let e=document.getElementById("print");e&&(e.innerHTML=t.join(" "))},increment:function(){return g+=this.state?.incr||1},reset:()=>g=0}}).start(t=>{t.addEventListener("op:increment",t=>{let e=document.getElementById("counter_para");e&&(e.innerHTML=g.toString())});let e=document.getElementById("echo-btn");e&&(e.onclick=async()=>{let e=document.getElementById("echo"),r=document.getElementById("echo-input");if(!e||!r)return;let n=await t.execute("echo",r&&r.value?r.value:"<empty>");e.innerHTML=n});let r=document.getElementById("incr1"),n=document.getElementById("incr5");r&&(r.onclick=()=>{t.pushState({incr:1})}),n&&(n.onclick=()=>{t.pushState({incr:5})})});