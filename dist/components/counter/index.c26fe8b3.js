var t,e,r,n=function(t,e,r,n,a){if("m"===n)throw TypeError("Private method is not writable");if("a"===n&&!a)throw TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!a:!e.has(t))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(t,r):a?a.value=r:e.set(t,r),r},a=function(t,e,r,n){if("a"===r&&!n)throw TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(t):n?n.value:e.get(t)};class s{constructor(e,r){this.type=e,this.payload=r,t.set(this,!1)}preventDefault(){n(this,t,!0,"f")}get defaultPrevented(){return a(this,t,"f")}}t=new WeakMap;class i{constructor(){e.set(this,new Map),r.set(this,new Set)}addEventListener(t,n){return t?(a(this,e,"f").has(t)||a(this,e,"f").set(t,new Set),a(this,e,"f").get(t)?.add(n)):a(this,r,"f").add(n),n}removeEventListener(t,n){null===t?a(this,r,"f").delete(n):a(this,e,"f").get(t)?.delete(n)}emitEvent(t,n){let i=new s(t,n);return a(this,e,"f").get(t)?.forEach(t=>t(i)),a(this,r,"f").forEach(t=>t(i)),i}clearListeners(){a(this,r,"f").clear(),a(this,e,"f").clear()}}function o(t,e){return t.data&&"object"==typeof t.data&&t.data.__type===e?t.data:null}e=new WeakMap,r=new WeakMap;const l="undefined"!=typeof window&&window===window.self;async function h(t,e,r,n="*",a,s=5e3){return new Promise((i,l)=>{let h=new MessageChannel,c=h.port1,u=h.port2,d=!1;setTimeout(()=>{d||l(Error("Operation timeout"))},s||5e3),c.onmessage=async t=>{let r=o(t,e+":result");r&&(d=!0,i(r.payload))},u.onmessageerror=t=>{l(Error("Channel Error (in)"))},c.onmessageerror=t=>{l(Error("Channel Error (out)"))},t.postMessage({...r,__type:e,__port:u},{targetOrigin:n,transfer:[u,...a||[]]})})}const c="https://cdn.jsdelivr.net";async function u(t,e,r,n){n.startsWith("/")?n=n.slice(1):n.startsWith("./")&&(n=n.slice(2));let a=await fetch(function(t,e,r,n){var a;let s;if("github"===t){let[t,n]=e.split("/");s=`${c}/gh/${t}/${n}@${r}/`}else if("npm"===t)s=`${c}/npm/${e}@${r}/`;else throw Error("Invalid type ('npm' or 'github' expected)");return n?((a=n).startsWith("./")?a=a.slice(2):a.startsWith("/")&&(a=a.slice(1)),s+(n=a)):s}(t,e,r,n),{});if(!a.ok)throw Error(`Failed to load file: ${a.statusText}`).response=a,Error(`Failed to load file: ${a.statusText}`);return a}const d=t=>{var e;if(p())return removeEventListener("message",d);let r=o(t,"meta");r&&(e=r.meta,globalThis.$ER||(globalThis.$ER={}),globalThis.$ER.meta=e,m(r.meta.initialState),f("ready",{__token:r.meta.authToken},"*"),removeEventListener("message",d))};function p(){return globalThis.$ER?.meta}function m(t){globalThis.$ER||(globalThis.$ER={}),globalThis.$ER.state=t||{}}function f(t,e,r,n){l?window.parent.postMessage({...e,__type:t},r,n||[]):self.postMessage({...e,__type:t},r,n||[])}addEventListener("message",d);let g=0;new class extends i{constructor(t){super(),this.init=t,this.id="adapter_id:"+function(){let t="abcdefghijklmnopqrstuvwxyz0123456789",e="";for(let r=0;r<25;r++){let r=Math.floor(Math.random()*t.length);e+=t[r]}return e}(),this._started=!1,this.listen()}listen(){addEventListener("message",async t=>{if(t.origin!==this.init.provider||"string"!=typeof t?.data?.__type)return;let e=t.data.__type;switch(console.log("ADAPTER RECEIVED:",t.data),e){case"state_push":let r=t.data.state;if(!r||"object"!=typeof r)return this.err("Invalid state received",t);m(r),this.emitEvent("state_update",t.data.state);break;case"operation":let{args:n,operation:a,__port:s}=t.data;if(!s)return this.err("Operation Channel Error","Port not found");let i=await this.init.out?.[a];if("function"!=typeof i&&(i=null),s.onmessageerror=t=>{this.err("Operation Channel Error",t)},i)try{let t=await i.apply(this,n);s.postMessage({__type:"operation:result",payload:t}),this.emitEvent(`op:${a}`,{args:n,result:t,error:null})}catch(e){let t=this.err("Operation Execution Error",e);this.emitEvent(`op:${a}`,{args:n,result:void 0,error:t});return}else this.emitEvent(`op:${a}`,{args:n,result:void 0,error:null})}})}async start(t){return this._started?this:(this._started=!0,p())?(t&&t.apply(this,[this]),this):new Promise((e,r)=>{let n=!1;setTimeout(()=>{if(!n)return n=!0,r(Error("Provider start timeout"))},this.init.startTimeout||5e3),addEventListener("message",r=>{o(r,"meta")&&!n&&(n=!0,t&&t.apply(this,[this]),e(this))})})}get meta(){let t=p();if(!t)throw Error("Meta not defined. "+(this._started?"(unexpected)":"The adapter has not been started"));return t}get state(){return globalThis.$ER?.state||{}}err(t,e){let r=e instanceof Event?(e.message||e.data||"").toString():e instanceof Error?e.message:"",n=Error(`${t}${r?": "+r:""}`);return console.error(t,n),this.emitEvent("error",n),n}async execute(t,...e){return await h(l?parent:self,"operation",{args:e,operation:t,__token:this.meta.authToken},this.init.provider,[],this.init.operationTimeout)}async pushState(t,e){f("state_populate",{state:t,options:{merge:!e?.merge,populate:e?.populate!==!1},__token:this.meta.authToken},this.init.provider)}async loadFile(t){return await u(this.meta.type,this.meta.name,this.meta.version,t)}}({provider:"http://localhost:3444",out:{print:function(...t){let e=document.getElementById("print");e&&(e.innerHTML=t.join(" "))},increment:function(){return g+=this.state?.incr||1},reset:()=>g=0}}).start(t=>{t.addEventListener("op:increment",t=>{let e=document.getElementById("counter_para");e&&(e.innerHTML=g.toString())});let e=document.getElementById("echo-btn");e&&(e.onclick=async()=>{let e=document.getElementById("echo"),r=document.getElementById("echo-input");if(!e||!r)return;let n=await t.execute("echo",r&&r.value?r.value:"<empty>");e.innerHTML=n});let r=document.getElementById("incr1"),n=document.getElementById("incr5");r&&(r.onclick=()=>{t.pushState({incr:1})}),n&&(n.onclick=()=>{t.pushState({incr:5})})});