(()=>{"use strict";var t,e,r,a=function(t,e,r,a){if("a"===r&&!a)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!a:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?a:"a"===r?a.call(t):a?a.value:e.get(t)};class s{constructor(e,r){this.type=e,this.payload=r,t.set(this,!1)}preventDefault(){!function(t,e,r,a,s){if("m"===a)throw new TypeError("Private method is not writable");if("a"===a&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===a?s.call(t,r):s?s.value=r:e.set(t,r)}(this,t,!0,"f")}get defaultPrevented(){return a(this,t,"f")}}t=new WeakMap;class n{constructor(){e.set(this,new Map),r.set(this,new Set)}addEventListener(t,s){return t?(a(this,e,"f").has(t)||a(this,e,"f").set(t,new Set),a(this,e,"f").get(t)?.add(s)):a(this,r,"f").add(s),s}removeEventListener(t,s){null===t?a(this,r,"f").delete(s):a(this,e,"f").get(t)?.delete(s)}emitEvent(t,n){const o=new s(t,n);return a(this,e,"f").get(t)?.forEach((t=>t(o))),a(this,r,"f").forEach((t=>t(o))),o}clearListeners(){a(this,r,"f").clear(),a(this,e,"f").clear()}}function o(t,e){return t.data&&"object"==typeof t.data&&t.data.__type===e?t.data:null}e=new WeakMap,r=new WeakMap;const i="undefined"!=typeof window&&window===window.self;function h(t,e,r="*",a){i?window.parent.postMessage({...e,__type:t},r,a||[]):self.postMessage({...e,__type:t},r,a||[])}const l=t=>{if(u())return removeEventListener("message",l);const e=o(t,"meta");var r;e&&(console.log("Meta received",e.meta),r=e.meta,globalThis.$ER||(globalThis.$ER={}),globalThis.$ER.meta=r,d(e.meta.initialState),h("ready",{__token:e.meta.authToken}),removeEventListener("message",l))};function u(){return globalThis.$ER?.meta}function c(){return globalThis.$ER?.state||{}}function d(t){globalThis.$ER||(globalThis.$ER={}),globalThis.$ER.state=t||{}}addEventListener("message",l),new class extends n{constructor(t){super(),this.init=t,this.started=!1,this.listen()}listen(){addEventListener("message",(async t=>{if("string"==typeof t?.data?.__type)switch(t.data.__type){case"state_push":let e;e=t.data.options?.merge?this.init.mergeStates?this.init.mergeStates(c(),t.data.state):{...c(),...t.data.state}:t.data.state,d(e),this.emitEvent("state_push",t.data.state);break;case"operation":const{args:r,operation:a,__port:s}=t.data;if(!s)return this.err("Operation Channel Error","Port not found");let n=await(this.init.out?.[a]);if("function"!=typeof n&&(n=null),s.onmessageerror=t=>{this.err("Operation Channel Error",t)},n)try{const t=await n.apply(this,r);s.postMessage({__type:"operation:result",payload:t}),this.emitEvent(`op:${a}`,{args:r,result:t,error:null})}catch(t){const e=this.err("Operation Execution Error",t);return void this.emitEvent(`op:${a}`,{args:r,result:void 0,error:e})}else this.emitEvent(`op:${a}`,{args:r,result:void 0,error:null})}}))}async start(t){return this.started?(t&&t.apply(this,[this]),this):(this.started=!0,new Promise(((e,r)=>{let a=!1;setTimeout((()=>{if(!a)return a=!0,r(new Error("Provider start timeout"))}),this.init.startTimeout||5e3),addEventListener("message",(r=>{o(r,"meta")&&!a&&(a=!0,t&&t.apply(this,[this]),e(this))}))})))}get meta(){const t=u();if(!t)throw new Error("Meta not defined. "+(this.started?"(unexpected)":"The adapter has not been started"));return t}get state(){return c()}err(t,e){const r=e instanceof Event?(e.message||e.data||"").toString():e instanceof Error?e.message:"",a=new Error(`${t}${r?": "+r:""}`);return console.error(t,a),a}async execute(t,...e){return await async function(t,e,r,a="*",s,n=5e3){return new Promise(((i,h)=>{const l=new MessageChannel,u=l.port1,c=l.port2;let d=!1;setTimeout((()=>{d||h(new Error("Operation timeout"))}),n||5e3),u.onmessage=async t=>{const r=o(t,e+":result");r&&(d=!0,i(r.payload))},c.onmessageerror=t=>{h(new Error("Channel Error (in)"))},u.onmessageerror=t=>{h(new Error("Channel Error (out)"))},t.postMessage({...r,__type:e,__port:c},{targetOrigin:a,transfer:[c,...s||[]]})}))}(i?parent:self,"operation",{args:e,operation:t,__token:this.meta.authToken},"*",[],this.init.operationTimeout)}async pushState(t,e){!1!==e?.populate&&h("state_populate",{state:t,options:{}},"*"),d(t)}}({provider:"",out:{add:function(t,e){return Number.isInteger(t)||(t=0),Number.isInteger(e)||(e=0),t+e},substract:function(t,e){return Number.isInteger(t)||(t=0),Number.isInteger(e)||(e=0),t-e}}}).start((t=>{t.execute("alert","Math Adapter started"),t.addEventListener("op:logArea",(t=>{const[e]=t.payload.args,r=Math.PI*e*e;console.log("Area of circle with width",e,":",r)}))}))})();