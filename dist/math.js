(()=>{"use strict";var e,t,r,s=function(e,t,r,s){if("a"===r&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?s:"a"===r?s.call(e):s?s.value:t.get(e)};class a{constructor(t,r){this.type=t,this.payload=r,e.set(this,!1)}preventDefault(){!function(e,t,r,s,a){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===s?a.call(e,r):a?a.value=r:t.set(e,r)}(this,e,!0,"f")}get defaultPrevented(){return s(this,e,"f")}}e=new WeakMap;class n{constructor(){t.set(this,new Map),r.set(this,new Set)}addEventListener(e,a){return e?(s(this,t,"f").has(e)||s(this,t,"f").set(e,new Set),s(this,t,"f").get(e)?.add(a)):s(this,r,"f").add(a),a}removeEventListener(e,a){null===e?s(this,r,"f").delete(a):s(this,t,"f").get(e)?.delete(a)}emitEvent(e,n){const o=new a(e,n);return s(this,t,"f").get(e)?.forEach((e=>e(o))),s(this,r,"f").forEach((e=>e(o))),o}clearListeners(){s(this,r,"f").clear(),s(this,t,"f").clear()}}function o(e,t){return e.data&&"object"==typeof e.data&&e.data.__type===t?e.data:null}t=new WeakMap,r=new WeakMap;const i="undefined"!=typeof window&&window===window.self;function h(e,t,r="*",s){i?window.parent.postMessage({...t,__type:e},r,s||[]):self.postMessage({...t,__type:e},r,s||[])}const l=e=>{if(u())return removeEventListener("message",l);const t=o(e,"meta");var r;t&&(console.log("Meta received",t.meta),r=t.meta,globalThis.$ER||(globalThis.$ER={}),globalThis.$ER.meta=r,p(t.meta.initialState),h("ready",{__token:t.meta.authToken}),removeEventListener("message",l))};function u(){return globalThis.$ER?.meta}function c(){return globalThis.$ER?.state||{}}function p(e){globalThis.$ER||(globalThis.$ER={}),globalThis.$ER.state=e||{}}addEventListener("message",l),new class extends n{constructor(e){super(),this.init=e,this.started=!1,this.listen()}listen(){addEventListener("message",(async e=>{if("string"==typeof e?.data?.__type)switch(e.data.__type){case"state_push":let t;t=e.data.options?.merge?this.init.mergeStates?this.init.mergeStates(c(),e.data.state):{...c(),...e.data.state}:e.data.state,p(t),this.emitEvent("push_state",e.data.state);break;case"operation":const{args:r,operation:s,__port:a}=e.data;if(!a)return this.err("Operation Channel Error","Port not found");let n=await(this.init.out?.[s]);if("function"!=typeof n&&(n=null),a.onmessageerror=e=>{this.err("Operation Channel Error",e)},n)try{const e=await n.apply(this,r);a.postMessage({__type:"operation:result",payload:e}),this.emitEvent(`op:${s}`,{args:r,result:e,error:null})}catch(e){const t=this.err("Operation Execution Error",e);return void this.emitEvent(`op:${s}`,{args:r,result:void 0,error:t})}else this.emitEvent(`op:${s}`,{args:r,result:void 0,error:null})}}))}async start(e){return this.started?(e&&e.apply(this,[this]),this):(this.started=!0,new Promise(((t,r)=>{let s=!1;setTimeout((()=>{if(!s)return s=!0,r(new Error("Provider start timeout"))}),this.init.startTimeout||5e3),addEventListener("message",(r=>{o(r,"meta")&&!s&&(s=!0,e&&e.apply(this,[this]),t(this))}))})))}get meta(){const e=u();if(!e)throw new Error("Meta not defined. "+(this.started?"(unexpected)":"The adapter has not been started"));return e}get state(){return c()}err(e,t){const r=t instanceof Event?(t.message||t.data||"").toString():t instanceof Error?t.message:"",s=new Error(`${e}${r?": "+r:""}`);return console.error(e,s),s}async execute(e,...t){return await async function(e,t,r,s="*",a,n=5e3){return new Promise(((i,h)=>{const l=new MessageChannel,u=l.port1,c=l.port2;let p=!1;setTimeout((()=>{p||h(new Error("Operation timeout"))}),n||5e3),u.onmessage=async e=>{const r=o(e,t+":result");r&&(p=!0,i(r.payload))},c.onmessageerror=e=>{h(new Error("Channel Error (in)"))},u.onmessageerror=e=>{h(new Error("Channel Error (out)"))},e instanceof Worker?e.postMessage({...r,__type:t,__port:c},{transfer:[c,...a||[]]}):e.postMessage({...r,__type:t,__port:c},s,[c,...a||[]])}))}(i?parent:self,"operation",{args:t,operation:e,__token:this.meta.authToken},"*",[],this.init.operationTimeout)}async pushState(e,t){!1!==t?.populate&&h("state_populate",{state:e,options:{}}),p(e)}}({provider:"",out:{add:function(e,t){return Number.isInteger(e)||(e=0),Number.isInteger(t)||(t=0),e+t},substract:function(e,t){return Number.isInteger(e)||(e=0),Number.isInteger(t)||(t=0),e-t}}}).start((e=>{e.execute("alert","Math Adapter started"),e.addEventListener("op:logArea",(e=>{const[t]=e.payload.args,r=Math.PI*t*t;console.log("Area of circle with width",t,":",r)}))}))})();