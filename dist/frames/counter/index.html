<!DOCTYPE html>
<html>
    <head>
        <title>Test Extension (extensionrunner)</title>
        <script>(()=>{"use strict";var t,e,r,n=function(t,e,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(t):n?n.value:e.get(t)};class s{constructor(e,r){this.type=e,this.payload=r,t.set(this,!1)}preventDefault(){!function(t,e,r,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===n?s.call(t,r):s?s.value=r:e.set(t,r)}(this,t,!0,"f")}get defaultPrevented(){return n(this,t,"f")}}t=new WeakMap;class a{constructor(){e.set(this,new Map),r.set(this,new Set)}addEventListener(t,s){return t?(n(this,e,"f").has(t)||n(this,e,"f").set(t,new Set),n(this,e,"f").get(t)?.add(s)):n(this,r,"f").add(s),s}removeEventListener(t,s){null===t?n(this,r,"f").delete(s):n(this,e,"f").get(t)?.delete(s)}emitEvent(t,a){const o=new s(t,a);return n(this,e,"f").get(t)?.forEach((t=>t(o))),n(this,r,"f").forEach((t=>t(o))),o}clearListeners(){n(this,r,"f").clear(),n(this,e,"f").clear()}}function o(t,e){return t.data&&"object"==typeof t.data&&t.data.__type===e?t.data:null}e=new WeakMap,r=new WeakMap;const i="undefined"!=typeof window&&window===window.self;function c(t,e,r="*",n){i?window.parent.postMessage({...e,__type:t},r,n||[]):self.postMessage({...e,__type:t},r,n||[])}const l=t=>{if(h())return removeEventListener("message",l);const e=o(t,"meta");var r;e&&(console.log("Meta received",e.meta),r=e.meta,globalThis.$ER||(globalThis.$ER={}),globalThis.$ER.meta=r,d(e.meta.initialState),c("ready",{__token:e.meta.authToken}),removeEventListener("message",l))};function h(){return globalThis.$ER?.meta}function u(){return globalThis.$ER?.state||{}}function d(t){globalThis.$ER||(globalThis.$ER={}),globalThis.$ER.state=t||{}}addEventListener("message",l);let p=0;new class extends a{constructor(t){super(),this.init=t,this.id="adapter_id:"+function(){let t="";for(let e=0;e<25;e++)t+="abcdefghijklmnopqrstuvwxyz0123456789"[Math.floor(36*Math.random())];return t}(),this.started=!1,this.listen()}listen(){addEventListener("message",(async t=>{if("string"==typeof t?.data?.__type)switch(t.data.__type){case"state_push":let e;e=t.data.options?.merge?this.init.mergeStates?this.init.mergeStates(u(),t.data.state):{...u(),...t.data.state}:t.data.state,d(e),console.log("Received state_push",this.id,"New state:",this.state),this.emitEvent("state_push",t.data.state);break;case"operation":const{args:r,operation:n,__port:s}=t.data;if(!s)return this.err("Operation Channel Error","Port not found");let a=await(this.init.out?.[n]);if("function"!=typeof a&&(a=null),s.onmessageerror=t=>{this.err("Operation Channel Error",t)},a)try{const t=await a.apply(this,r);s.postMessage({__type:"operation:result",payload:t}),this.emitEvent(`op:${n}`,{args:r,result:t,error:null})}catch(t){const e=this.err("Operation Execution Error",t);return void this.emitEvent(`op:${n}`,{args:r,result:void 0,error:e})}else this.emitEvent(`op:${n}`,{args:r,result:void 0,error:null})}}))}async start(t){return this.started?(t&&t.apply(this,[this]),this):(this.started=!0,new Promise(((e,r)=>{let n=!1;setTimeout((()=>{if(!n)return n=!0,r(new Error("Provider start timeout"))}),this.init.startTimeout||5e3),addEventListener("message",(r=>{o(r,"meta")&&!n&&(n=!0,t&&t.apply(this,[this]),e(this))}))})))}get meta(){const t=h();if(!t)throw new Error("Meta not defined. "+(this.started?"(unexpected)":"The adapter has not been started"));return t}get state(){return u()}err(t,e){const r=e instanceof Event?(e.message||e.data||"").toString():e instanceof Error?e.message:"",n=new Error(`${t}${r?": "+r:""}`);return console.error(t,n),n}async execute(t,...e){return await async function(t,e,r,n="*",s,a=5e3){return new Promise(((i,c)=>{const l=new MessageChannel,h=l.port1,u=l.port2;let d=!1;setTimeout((()=>{d||c(new Error("Operation timeout"))}),a||5e3),h.onmessage=async t=>{const r=o(t,e+":result");r&&(d=!0,i(r.payload))},u.onmessageerror=t=>{c(new Error("Channel Error (in)"))},h.onmessageerror=t=>{c(new Error("Channel Error (out)"))},t.postMessage({...r,__type:e,__port:u},{targetOrigin:n,transfer:[u,...s||[]]})}))}(i?parent:self,"operation",{args:e,operation:t,__token:this.meta.authToken},"*",[],this.init.operationTimeout)}async pushState(t,e){console.log("pushState",this.id,t),!1!==e?.populate&&c("state_populate",{state:t,options:{}},"*"),d(t)}}({provider:"",out:{print:function(...t){const e=document.getElementById("print");e&&(e.innerHTML=t.join(" "))},increment:function(){return p+=this.state?.incr||1},reset:()=>p=0}}).start((t=>{t.addEventListener("op:increment",(t=>{const e=document.getElementById("counter_para");e&&(e.innerHTML=p.toString())}));const e=document.getElementById("echo-btn");e&&(e.onclick=async()=>{const e=document.getElementById("echo"),r=document.getElementById("echo-input");if(!e||!r)return;const n=await t.execute("echo",r&&r.value?r.value:"<empty>");e.innerHTML=n});const r=document.getElementById("incr1"),n=document.getElementById("incr5");r&&(r.onclick=()=>{t.pushState({incr:1})}),n&&(n.onclick=()=>{t.pushState({incr:5})})}))})();</script>
    </head>
    <body>
        <h1>Test Extension (extensionrunner)</h1>
        <h4>Counter</h4>
        <p id="counter_para" />
        <h4>Echo</h4>
        <p id="echo" />
        <input id="echo-input" />
        <button id="echo-btn" />
        <h4>Printing</h4>
        <p id="print"></p>
        <h4>Populate state</h4>
        <button id="incr5">Set incr to 5</button>
        <button id="incr1">Set incr to 1</button>
    </body>
</html>
