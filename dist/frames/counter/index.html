<!DOCTYPE html>
<html>
    <head>
        <title>Test Extension (extensionrunner)</title>
        <script>(()=>{"use strict";var e,t=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};function n(e,t){return e.data&&"object"==typeof e.data&&e.data.__type===t?e.data:null}const r="undefined"!=typeof window&&window===window.self;function o(e,t,n="*",o){r?window.parent.postMessage({...t,__type:e},n,o||[]):self.postMessage({...t,__type:e},n,o||[])}class a{constructor(){e.set(this,new Map)}addEventListener(n,r){t(this,e,"f").has(n)||t(this,e,"f").set(n,new Set),t(this,e,"f").get(n)?.add(r)}removeEventListener(n,r){t(this,e,"f").get(n)?.delete(r)}notifyListeners(n,...r){t(this,e,"f").get(n)?.forEach((e=>e(...r)))}}e=new WeakMap;const s=e=>{if(globalThis.meta&&"object"==typeof globalThis.meta)return removeEventListener("message",s);const t=n(e,"meta");t&&(console.log("Meta received",t.meta),globalThis.meta=t.meta,o("ready",{__token:t.meta.authToken}),removeEventListener("message",s))};addEventListener("message",s);const i=new class extends a{constructor(e){super(),this.init=e,this.listen()}listen(){addEventListener("message",(async e=>{if("string"==typeof e?.data?.__type)switch(e.data.__type){case"state_push":this.init.onPushState?.(e.data.state);break;case"event":this.notifyListeners?.(e.data.event,e.data.args);break;case"operation":const{args:t,operation:n,__port:r}=e.data;if(!r)return this.err("Operation Channel Error","Port not found");const o=await(this.init.out?.[n]);if("function"!=typeof o)return this.err("Operation not found",null);r.onmessageerror=e=>{this.err("Operation Channel Error",e)};try{const e=await o(...t||[]);r.postMessage({__type:"operation:result",payload:e})}catch(e){return this.err("Operation Execution Error",e)}}}))}get meta(){const e=globalThis.meta;if(!e||"object"!=typeof e)throw new Error("Meta not defined");return e}err(e,t){const n=t instanceof Event?(t.message||t.data||"").toString():t instanceof Error?t.message:"",r=new Error(`${e}${n?": "+n:""}`);return this?.init?.onError?.(r),console.error(e,r),r}async execute(e,...t){return await async function(e,t,r,o="*",a,s=5e3){return new Promise(((i,c)=>{const p=new MessageChannel,u=p.port1,d=p.port2;let h=!1;setTimeout((()=>{h||c(new Error("Operation timeout"))}),s||5e3),u.onmessage=async e=>{const r=n(e,t+":result");r&&(h=!0,i(r.payload))},d.onmessageerror=e=>{c(new Error("Channel Error (in)"))},u.onmessageerror=e=>{c(new Error("Channel Error (out)"))},e instanceof Worker?e.postMessage({...r,__type:t,__port:d},{transfer:[d,...a||[]]}):e.postMessage({...r,__type:t,__port:d},o,[d,...a||[]])}))}(r?parent:self,"operation",{args:t,operation:e,__token:this.meta.authToken},"*",[],this.init.operationTimeout)}async emitEvent(e,t){o("event",{event:e,args:t})}async pushState(e,t=!0){o("state_push",{state:e,populate:t})}}({provider:"",out:{}});i.addEventListener("increment_counter",(e=>{document.getElementById("counter").innerText=e}));const c=document.getElementById("echo-btn");c&&(c.onClick=()=>{!function(){const e=document.getElementById("echo-input");i.execute("echo",e&&e.value?e.value:"<empty>")}()})})();</script>
    </head>
    <body>
        <h1>Test Extension (extensionrunner)</h1>
        <span id="counter" />
        <span id="echo" />
        <input id="echo-input" />
        <button id="echo-btn" />
    </body>
</html>
