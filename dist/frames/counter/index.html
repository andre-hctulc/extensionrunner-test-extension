<!DOCTYPE html>
<html>
    <head>
        <title>Test Extension (extensionrunner)</title>
        <script>(()=>{"use strict";var e,t,n,r=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class s{constructor(t,n){this.type=t,this.payload=n,e.set(this,!1)}preventDefault(){!function(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===r?s.call(e,n):s?s.value=n:t.set(e,n)}(this,e,!0,"f")}get defaultPrevented(){return r(this,e,"f")}}e=new WeakMap;class a{constructor(){t.set(this,new Map),n.set(this,new Set)}addEventListener(e,s){return e?(r(this,t,"f").has(e)||r(this,t,"f").set(e,new Set),r(this,t,"f").get(e)?.add(s)):r(this,n,"f").add(s),s}removeEventListener(e,s){null===e?r(this,n,"f").delete(s):r(this,t,"f").get(e)?.delete(s)}emitEvent(e,a){const o=new s(e,a);return r(this,t,"f").get(e)?.forEach((e=>e(o))),r(this,n,"f").forEach((e=>e(o))),o}clearListeners(){r(this,n,"f").clear(),r(this,t,"f").clear()}}function o(e,t){return e.data&&"object"==typeof e.data&&e.data.__type===t?e.data:null}t=new WeakMap,n=new WeakMap;const i="undefined"!=typeof window&&window===window.self;function c(e,t,n="*",r){i?window.parent.postMessage({...t,__type:e},n,r||[]):self.postMessage({...t,__type:e},n,r||[])}const l=e=>{if(h())return removeEventListener("message",l);const t=o(e,"meta");var n;t&&(console.log("Meta received",t.meta),n=t.meta,globalThis.$ER||(globalThis.$ER={}),globalThis.$ER.meta=n,d(t.meta.initialState),c("ready",{__token:t.meta.authToken}),removeEventListener("message",l))};function h(){return globalThis.$ER?.meta}function u(){return globalThis.$ER?.state||{}}function d(e){globalThis.$ER||(globalThis.$ER={}),globalThis.$ER.state=e||{}}addEventListener("message",l);let p=0;new class extends a{constructor(e){super(),this.init=e,this.started=!1,this.listen()}listen(){addEventListener("message",(async e=>{if("string"==typeof e?.data?.__type)switch(e.data.__type){case"state_push":let t;e.data.options?.merge?this.init.mergeStates?t=this.init.mergeStates(u(),e.data.state):t({...u(),...e.data.state}):t=e.data.state,d(t),this.emitEvent("push_state",e.data.state);break;case"operation":const{args:n,operation:r,__port:s}=e.data;if(!s)return this.err("Operation Channel Error","Port not found");let a=await(this.init.out?.[r]);if("function"!=typeof a&&(a=null),s.onmessageerror=e=>{this.err("Operation Channel Error",e)},a)try{const e=await a.apply(this,n);s.postMessage({__type:"operation:result",payload:e}),this.emitEvent(`op:${r}`,{args:n,result:e,error:null})}catch(e){const t=this.err("Operation Execution Error",e);return void this.emitEvent(`op:${r}`,{args:n,result:void 0,error:t})}else this.emitEvent(`op:${r}`,{args:n,result:void 0,error:null})}}))}async start(e){return this.started?(e&&e.apply(this,[this]),this):(this.started=!0,new Promise(((t,n)=>{let r=!1;setTimeout((()=>{if(!r)return r=!0,n(new Error("Provider start timeout"))}),this.init.startTimeout||5e3),addEventListener("message",(n=>{o(n,"meta")&&!r&&(r=!0,e&&e.apply(this,[this]),t(this))}))})))}get meta(){const e=h();if(!e)throw new Error("Meta not defined. "+(this.started?"(unexpected)":"The adapter has not been started"));return e}get state(){return u()}err(e,t){const n=t instanceof Event?(t.message||t.data||"").toString():t instanceof Error?t.message:"",r=new Error(`${e}${n?": "+n:""}`);return console.error(e,r),r}async execute(e,...t){return await async function(e,t,n,r="*",s,a=5e3){return new Promise(((i,c)=>{const l=new MessageChannel,h=l.port1,u=l.port2;let d=!1;setTimeout((()=>{d||c(new Error("Operation timeout"))}),a||5e3),h.onmessage=async e=>{const n=o(e,t+":result");n&&(d=!0,i(n.payload))},u.onmessageerror=e=>{c(new Error("Channel Error (in)"))},h.onmessageerror=e=>{c(new Error("Channel Error (out)"))},e instanceof Worker?e.postMessage({...n,__type:t,__port:u},{transfer:[u,...s||[]]}):e.postMessage({...n,__type:t,__port:u},r,[u,...s||[]])}))}(i?parent:self,"operation",{args:t,operation:e,__token:this.meta.authToken},"*",[],this.init.operationTimeout)}async pushState(e,t){!1!==t?.populate&&c("state_populate",{state:e,options:{}}),d(e)}}({provider:"",out:{print:function(...e){const t=document.getElementById("print");t&&(t.innerHTML=e.join(" "))},increment:function(){return p+=this.state?.incr||1},reset:()=>p=0}}).start((e=>{const t=document.getElementById("counter");e.addEventListener("op:increment",(e=>{t&&(t.innerHTML=p.toString())}));const n=document.getElementById("echo-btn"),r=document.getElementById("echo-input"),s=document.getElementById("echo");n&&s&&r&&(n.onclick=async()=>{const t=await e.execute("echo",r&&r.value?r.value:"<empty>");s.innerHTML=t});const a=document.getElementById("incr1"),o=document.getElementById("incr5");a&&(a.onclick=()=>{e.pushState({incr:1})}),o&&(o.onclick=()=>{e.pushState({incr:5})})}))})();</script>
    </head>
    <body>
        <h1>Test Extension (extensionrunner)</h1>
        <h4>Counter</h4>
        <span id="counter" />
        <h4>Echo</h4>
        <p id="echo" />
        <input id="echo-input" />
        <button id="echo-btn" />
        <h4>Printing</h4>
        <p id="print"></p>
        <h4>Populate state</h4>
        <button id="incr5">Set incr to 5</button>
        <button id="incr1">Set incr to 1</button>
    </body>
</html>
