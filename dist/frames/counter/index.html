<!DOCTYPE html>
<html>
    <head>
        <title>Test Extension (extensionrunner)</title>
        <script>(()=>{"use strict";var e,t=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};class r{constructor(){e.set(this,new Map)}addEventListener(r,n){t(this,e,"f").has(r)||t(this,e,"f").set(r,new Set),t(this,e,"f").get(r)?.add(n)}removeEventListener(r,n){t(this,e,"f").get(r)?.delete(n)}notifyListeners(r,...n){t(this,e,"f").get(r)?.forEach((e=>e(...n)))}}e=new WeakMap;const n=new class extends r{constructor(){super(),this.out={},self.onmessage=async e=>{if("string"==typeof e?.data?.__type)switch(e.data.__type){case"state_push":this.onPushState?.(e.data.state);break;case"event":this.notifyListeners?.(e.data.event,e.data.args);break;case"operation":const{args:t,operation:r,__port:n}=e.data;if(!n)return this.err("Operation Channel Error","Port not found");const s=await(this.out?.[r]);if("function"!=typeof s)return this.err("Operation not found",null);n.onmessageerror=e=>{this.err("Operation Channel Error",e)};try{const e=await s(...t||[]);n.postMessage({__type:"operation:result",payload:e})}catch(e){return this.err("Operation Execution Error",e)}}},self.onmessageerror=e=>{this.err("Message Error",e)},self.onerror=e=>{this.err("Uncaught Error",e)}}err(e,t){const r=t instanceof Event?(t.message||t.data||"").toString():t instanceof Error?t.message:"",n=new Error(`${e}${r?": "+r:""}`);return this?.onError?.(n),n}postMessage(e,t,r){postMessage({__type:e,...t},"*",r)}async execute(e,...t){return await async function(e,t,r,n,s=5e3){return new Promise(((o,a)=>{const i=new MessageChannel,c=i.port1,p=i.port2;let u=!1;setTimeout((()=>{u||a(new Error("Operation timeout"))}),s||5e3),c.onmessage=async e=>{const r=function(e,t){return e.data&&"object"==typeof e.data&&e.data.__type===t?e.data:null}(e,t+":result");r&&(u=!0,o(r.payload))},p.onmessageerror=e=>{a(new Error("Channel Error (in)"))},c.onmessageerror=e=>{a(new Error("Channel Error (out)"))},e instanceof Worker?e.postMessage({...r,__type:t,__port:p},{transfer:[p,...n]}):e.postMessage({...r,__type:t,__port:p},"*",[p,...n])}))}(self,"operation",{args:t,operation:e},[],this.operationTimeout)}async emitEvent(e,t){this.postMessage("event",{event:e,args:t})}async pushState(e,t=!0){this.postMessage("state_push",{state:e,populate:t})}};n.addEventListener("increment_counter",(e=>{document.getElementById("counter").innerText=e}));const s=document.getElementById("echo-btn");s&&(s.onClick=()=>{!function(){const e=document.getElementById("echo-input");n.execute("echo",e&&e.value?e.value:"<empty>")}()})})();</script>
    </head>
    <body>
        <h1>Test Extension (extensionrunner)</h1>
        <span id="counter" />
        <span id="echo" />
        <input id="echo-input" />
        <button id="echo-btn" />
    </body>
</html>
